# 跨平台 WebView Bridge SDK 开发规范（v1）

## 1. 目标与范围

本规范用于指导 AI 或工程团队开发一套 **跨平台 WebView Bridge SDK**，覆盖以下三端：

* iOS SDK
* Android SDK
* Web JS SDK（TypeScript 实现）

SDK 的目标是：

* 快速创建 WebView 并加载本地或内置 Web 资源
* 为 Web 应用提供统一、稳定、可扩展的 Native 能力调用方式
* 屏蔽平台差异，提供一致的 JS API 体验
* 支持模块化扩展、权限管理、错误治理与长期演进

本 SDK 面向 **工程级使用场景**，不是 Demo 或一次性方案。

---

## 2. 总体架构

SDK 必须分为三层，且三层职责严格隔离：

### 2.1 资源加载层（Resource Layer）

职责：

* 通过自定义 schema + host 加载 Web 资源
* 将 URL 映射到本地目录或内置资源
* 不参与任何 JS ↔ Native 通信逻辑

要求：

* iOS 使用 Custom URL Scheme Handler
* Android 使用 shouldInterceptRequest
* 支持目录映射与文件遍历加载

---

### 2.2 通信协议层（Bridge Protocol Layer）

职责：

* 定义 JS 与 Native 的通信协议
* 管理请求、响应、回调、错误
* 保证通信的可预测性与可调试性

该层不包含具体业务能力。

---

### 2.3 能力模块层（Capability Modules）

职责：

* 提供具体 Native 能力（权限、设备信息等）
* 以模块形式注册到 Bridge
* 支持独立扩展与版本演进

---

## 3. 通信协议规范（核心）

### 3.1 协议版本

所有请求必须包含协议版本：

```json
{
  "version": "1.0",
  "type": "Module.Method",
  "params": {},
  "callbackId": "uuid"
}
```

协议版本用于未来升级，不允许省略。

---

### 3.2 请求结构

字段说明：

* version: 协议版本号（字符串）
* type: 能力标识，格式为 Module.Method
* params: 参数对象，可为空
* callbackId: 本次请求唯一 ID，由 Web SDK 生成

---

### 3.3 响应结构

```json
{
  "callbackId": "uuid",
  "code": 0,
  "msg": "",
  "data": {}
}
```

字段说明：

* callbackId: 对应请求 ID
* code: 错误码（0 表示成功）
* msg: 人类可读错误信息
* data: 返回数据

---

### 3.4 错误码规范

错误码必须分段定义：

* 0: 成功
* 1xxx: 协议错误（JSON 非法、字段缺失）
* 2xxx: 能力不存在或不支持
* 3xxx: 权限相关错误
* 4xxx: 设备或系统限制
* 5xxx: 内部异常

禁止仅使用 0 / 非 0 粗粒度错误。

---

### 3.5 超时与取消

* Web SDK 必须支持请求超时
* 超时后自动清理 callback
* Native 返回晚到数据应被丢弃

---

## 4. 生命周期模型

SDK 必须显式管理以下生命周期：

* Bridge 初始化完成（BridgeReady）
* WebView 页面加载完成
* 页面 reload
* WebView 销毁
* App 前后台切换

规则：

* Bridge 未 ready 前禁止能力调用
* 页面 reload 必须清理所有 pending callback
* WebView 销毁后禁止任何回调

---

## 5. 模块化能力设计

### 5.1 模块定义

每个能力模块必须：

* 有唯一模块名
* 声明支持的方法列表
* 独立处理参数校验
* 返回异步结果

模块不允许直接依赖其他模块实现。

---

### 5.2 模块注册机制

Bridge 启动时统一注册模块，例如：

* PermissionModule
* DeviceModule

Bridge 根据 type 路由请求。

---

### 5.3 模块扩展规则

* 新增模块不得修改 Bridge 核心逻辑
* 模块可声明所需权限
* 模块可声明最低系统版本

---

## 6. 必须内置的基础模块（v1）

本章节定义 **v1 版本必须内置的功能模块集合**。这些模块构成 SDK 的“基础能力面”，是后续所有 Web 应用与业务模块的公共依赖。

所有模块均需遵循统一协议、错误码与异步模型规范。

---

### 6.1 App 模块（App）

用于控制和获取宿主应用级别的信息与行为。

支持能力：

* App.GetLaunchParams
  获取应用启动参数（URL Scheme / Intent / Universal Link 等）

* App.Exit
  请求宿主应用退出（由宿主自行决定是否允许）

* App.GetLifecycleState
  获取当前应用生命周期状态（foreground / background）

---

### 6.2 Device 模块（Device）

用于获取设备与系统的稳定信息。

支持能力：

* Device.GetInfo
  返回以下稳定字段：

  * os
  * osVersion
  * appVersion
  * deviceModel
  * language
  * screenInfo（width / height / scale / safeArea）

字段一经发布，禁止随意删除或改名。

---

### 6.3 Permission 模块（Permission）

用于统一管理系统权限状态与请求。

支持能力：

* Permission.GetStatus
  查询指定权限当前状态

* Permission.Request
  请求指定权限

权限类型至少包括：

* contact
* album
* camera
* microphone
* video
* clipboard（如平台支持）

返回统一权限状态结构，例如：

* granted
* denied
* restricted
* notDetermined

---

### 6.4 Clipboard 模块（Clipboard）

用于访问系统剪切板。

支持能力：

* Clipboard.Get
  获取当前剪切板内容

* Clipboard.Set
  设置剪切板内容

需遵守平台隐私与安全限制。

---

### 6.5 Haptics 模块（Haptics）

用于触发设备震动与触觉反馈。

支持能力：

* Haptics.Vibrate
  触发一次标准震动

* Haptics.Impact
  触发指定强度的触觉反馈（light / medium / heavy）

---

### 6.6 StatusBar 模块（StatusBar）

用于控制系统状态栏样式。

支持能力：

* StatusBar.SetStyle
  设置状态栏样式（light / dark）

宿主应用可自行决定是否支持。

---

### 6.7 System 模块（System）

用于调用系统级跳转能力。

支持能力：

* System.OpenURL
  打开指定 URL（tel / sms / mailto / https 等）

* System.CanOpenURL
  判断指定 URL 是否可被系统处理

返回结果必须明确区分：

* 不支持
* 被系统拦截
* 调用成功

---

### 6.8 Storage 模块（Storage）

用于访问宿主应用的本地持久化存储。

支持能力：

* Storage.Set
  设置键值数据

* Storage.Get
  获取键值数据

* Storage.Remove
  删除指定键

实现要求：

* iOS：UserDefaults / Keychain（按敏感级别区分）
* Android：SharedPreferences / Keystore

---

---

## 7. Web JS SDK 规范

除请求-响应模式外，Web JS SDK 还必须支持 **Native → Web 的事件派发机制**。

### 7.1 基本职责

* 封装协议细节
* 提供 Promise 风格 API
* 管理 callbackId 映射
* 支持能力检测与降级

---

### 7.2 API 风格

禁止直接暴露 send(type, params) 给业务使用。

必须提供语义化 API，例如：

* Bridge.permission.request()
* Bridge.device.getInfo()

---

### 7.3 回调管理

* 使用 callbackId 映射表
* Native 仅返回 callbackId
* JS SDK 负责派发 Promise resolve/reject

---

## 8. Native → Web 事件机制（Event Bridge）

SDK 必须支持 Native 主动向 Web 发送事件，用于状态变化、系统通知与被动更新场景。

---

### 8.1 事件模型

事件采用发布-订阅模型（addEventListener / removeEventListener）。

事件结构示例：

```json
{
  "event": "System.AppearanceChanged",
  "data": {}
}
```

---

### 8.2 Web JS SDK 要求

Web SDK 必须提供：

* addEventListener(eventName, handler)
* removeEventListener(eventName, handler)

并支持多个监听器同时存在。

---

### 8.3 必须内置的系统事件（v1）

* System.AppearanceChanged
  系统深色 / 浅色模式变化

* System.FontScaleChanged
  系统字体大小变化

* App.Foreground
  应用进入前台

* App.Background
  应用进入后台

* App.ExitRequested
  Native 请求 Web 做清理后退出

---

### 8.4 事件派发规则

* 事件不需要 callbackId
* 事件必须保证顺序派发
* WebView 销毁后禁止派发事件

---

## 9. 能力发现与降级

SDK 必须支持：

* 查询当前可用能力列表
* 判断某能力是否支持
* Web 环境下返回明确错误

---

## 9. 调试与可观测性

必须支持：

* Debug 模式开关
* JS ↔ Native 调用日志
* requestId 全链路追踪

---

## 10. 异步模型要求

* iOS：支持 async/await 或 RxSwift
* Android：使用 Coroutine / Flow
* JS：Promise

禁止同步阻塞 Bridge 主线程。

---

## 11. 示例代码与验证要求（必须）

SDK 必须提供 **完整、可运行、可验证的示例代码**，用于快速验证 Bridge 逻辑与跨端通信正确性。

### 11.1 示例代码目标

示例代码的目标不是展示 UI，而是：

* 验证 Web ↔ Native 通信链路
* 验证协议格式与回调机制
* 验证模块注册与路由是否正确
* 作为后续开发与调试的参考基线

---

### 11.2 必须提供的示例内容

每个平台必须至少包含以下示例：

#### Web 示例（HTML + JS / TS）

* 一个最小 HTML 页面
* 调用 JS SDK 的示例代码，例如：

  * 获取设备信息
  * 请求权限
* 显示成功 / 失败结果

示例代码必须可直接运行在 WebView 中。

---

#### iOS 示例 App

* 使用 SDK 创建 WebView
* 通过自定义 schema 加载本地 Web 示例页面
* 注册至少两个模块（Permission / Device）
* 打印完整调用与回调日志

示例应能在 Xcode 中直接运行。

---

#### Android 示例 App

* 使用 SDK 创建 WebView
* 通过 intercepted url 加载本地 Web 示例页面
* 注册至少两个模块（Permission / Device）
* 打印完整调用与回调日志

示例应能在 Android Studio 中直接运行。

---

### 11.3 示例与 SDK 的关系

* 示例代码必须使用 SDK 的公开 API
* 禁止示例代码绕过 SDK 内部实现
* 示例必须随 SDK 版本同步更新

---

## 12. SDK 分发与集成规范

SDK 必须支持被其他应用以 **私有依赖** 的方式引入，不要求发布到公共仓库。

---

### 12.1 iOS 分发要求

* 使用 Swift Package Manager（SPM）
* 提供 Package.swift
* 支持通过私有 Git 仓库引入
* 示例项目通过 SPM 依赖 SDK

---

### 12.2 Android 分发要求

* 使用 Gradle / Maven 依赖方式
* 支持私有 Maven 仓库或 Git 方式引入
* 示例项目通过 Gradle 依赖 SDK

---

### 12.3 Web JS SDK 分发要求

* 使用 npm 规范打包
* 支持发布到私有 npm registry
* 提供 package.json 与类型声明文件（.d.ts）

---

### 12.4 版本管理要求

* iOS / Android / Web SDK 必须使用统一语义化版本号
* 示例项目必须明确依赖版本号
* 协议版本与 SDK 版本需有清晰对应关系
  n

---

## 13. 非目标（明确不做）

* 不负责业务 UI
* 不直接暴露系统原生 API
* 不允许 JS 直接执行 Native 代码

---

## 12. v1 设计原则

* 能力少，但规则完整
* 协议稳定，优先向后兼容
* 扩展点明确，避免破坏式修改

本规范是 SDK 开发的最高约束，任何实现不得随意偏离。
