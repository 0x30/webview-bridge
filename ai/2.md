# 【优化阶段开发指令｜基于《跨平台 WebView Bridge SDK 优化与扩展规范》】

## 一、优化目标（不可偏离）

当前 SDK v1 已完成，现进入 **优化与工程完善阶段**，目标是：

1. Web 示例升级为真实业务技术栈（Vite + Vue3 + Vant）
2. 补齐 iOS / Android 中被省略或简化的工程级实现
3. 提供三方极易扩展的新 Module 能力与完整文档
4. Web SDK 支持 **开发态直接引入（边开发、边引用）**

不得修改 v1 协议，不得破坏已有能力。

---

## 二、Web 示例工程优化（必须支持开发态直接引用 SDK）

### 2.1 技术栈（必须）

* Vite
* Vue 3（Composition API）
* TypeScript
* Vant UI

禁止使用纯 HTML Demo。

---

### 2.2 SDK 引入方式（重点）

Web SDK **必须支持在开发态被直接引用源码**：

* 不需要 build SDK
* 不需要 publish npm 包
* SDK 修改后，Web 示例立即生效
* TypeScript 类型实时生效

### 强制要求实现方式

* 使用 **monorepo + workspace**
* Web SDK 与 Web 示例位于同一仓库
* Web 示例通过 workspace 方式依赖 SDK

示例结构：

```text
repo/
├── packages/
│   ├── web-sdk/
│   │   ├── src/
│   │   ├── package.json
│   │   └── tsconfig.json
│   └── web-example/
│       ├── src/
│       ├── vite.config.ts
│       └── package.json
```

`web-example/package.json`：

```json
{
  "dependencies": {
    "@your/web-sdk": "workspace:*"
  }
}
```

---

### 2.3 Web SDK 工程约束

Web SDK 必须满足：

* 入口直接指向 `src/index.ts`
* 使用 ESM
* 不强制依赖 dist 目录
* 提供完整 TS 类型

示例：

```json
{
  "name": "@your/web-sdk",
  "type": "module",
  "exports": {
    ".": {
      "import": "./src/index.ts"
    }
  }
}
```

---

### 2.4 Web 示例必须覆盖的场景

Web 示例工程至少包含：

* 获取设备信息并渲染 UI
* 权限查询与请求流程
* 调用系统能力（震动 / 打开 URL）
* Native → Web 事件监听（字体变化 / 深色模式）

示例用于 **回归验证，不是展示 UI**。

---

## 三、iOS SDK 优化补全（工程级要求）

### 3.1 WebView 容器标准化

iOS SDK 必须提供：

* 标准 WebView 创建与配置
* Custom URL Scheme Handler 完整实现
* JS Bridge 注入与初始化时序控制
* WebView 生命周期绑定

禁止业务侧自行拼装 WebView。

---

### 3.2 Bridge 核心补全

必须补齐以下实现：

* callbackId 生命周期管理
* 超时处理与晚到回调丢弃
* WebView reload / destroy 清理逻辑
* App 前后台切换处理

所有能力调用必须是异步（async/await 或 RxSwift）。

---

### 3.3 iOS Module 扩展机制

SDK 必须提供：

* Module 基类
* 方法注册与路由
* 权限声明
* 统一回调工具方法

三方 Module **只能继承基类扩展**，不得直接操作 Bridge 内部。

---

## 四、Android SDK 优化补全（工程级要求）

### 4.1 WebView 加载与安全

Android SDK 必须完整实现：

* shouldInterceptRequest 资源映射
* WebView 安全配置
* Bridge JS 注入与初始化控制

---

### 4.2 Bridge 核心补全

必须补齐：

* JSON 协议校验
* Coroutine Scope 生命周期管理
* callbackId 映射与清理
* WebView 销毁绑定

禁止在主线程执行耗时逻辑。

---

### 4.3 Android Module 扩展机制

SDK 必须提供：

* Module 抽象接口
* 方法分发
* 权限校验 Hook
* 异步结果返回封装

三方 Module 不得依赖 WebView 具体实现。

---

## 五、三方 Module 扩展（必须重点实现）

### 5.1 扩展目标

SDK 必须保证：

* 三方无需修改 SDK 源码即可扩展能力
* Module 可独立维护
* Module 不影响核心稳定性

---

### 5.2 扩展规则

三方 Module 必须：

* 定义唯一模块名
* 明确支持的方法
* 明确参数与返回结构
* 遵循统一错误码规范

---

### 5.3 扩展示例（必须）

SDK 必须提供：

* iOS 扩展示例 Module
* Android 扩展示例 Module
* Web 对应 API 示例

---

## 六、必须输出的文档（不可缺）

必须同时提供：

1. 《Module 扩展开发指南》
2. 示例工程运行说明
3. SDK 开发态引用说明（workspace）

---

## 七、禁止事项（重要）

* 禁止 npm link 作为正式方案
* 禁止示例绕过 SDK 内部实现
* 禁止只给 README 不给可运行代码
* 禁止破坏 v1 协议

---

## 最终要求

输出内容必须包括：

* 可运行 Web 示例（Vite + Vue + Vant）
* 可扩展的 iOS / Android SDK 实现
* 清晰、可执行的扩展文档

**本阶段目标是将 SDK 从“可用”提升为“可长期演进、可被三方使用的工程级基础设施”。**
